{
    "contents" : "shinyServer(function(input, output) {\n    \n    findJMbayesObjs <- reactive({\n        if (!is.null(input$RDfile)) {\n            inFile <- input$RDfile\n            load(inFile$datapath)\n            objs <- ls()\n            ss <- sapply(objs, function (o) class(get(o))) == \"JMbayes\"\n            if (all(!ss)) {\n                stop(\"\\nIt seems that there is no joint model fitted by jointModelBayes() \", \n                     \"in the workspace that you loaded ...\")\n            }\n            out <- objs[ss]\n            names(out) <- out\n            out\n        }\n    })\n    \n    output$modelChoose <- renderUI({\n        if (!is.null(input$RDfile)) {\n            inFile <- input$RDfile\n            load(inFile$datapath)\n            objs <- findJMbayesObjs()\n            selectInput(\"model\", \"Choose joint model:\", objs, objs[1L])\n        }\n    })\n    \n    loadObject <- reactive({\n        if (!is.null(input$RDfile) && !is.null(input$model)) {\n            inFile <- input$RDfile\n            load(inFile$datapath)\n            objs <- findJMbayesObjs()\n            choice <- input$model\n            get(objs[input$model])\n        }\n    })\n        \n    dataObject <- reactive({\n        if (!is.null(input$RDfile) && !is.null(input$model)) {\n            object <- loadObject()\n            forms <- object$Forms[c(\"formYx\", \"formYz\", \"formT\")]\n            forms$formT <- reformulate(attr(delete.response(object$Terms$termsT), \"term.labels\"))\n            nams <- unique(unlist(lapply(forms, all.vars), use.names = FALSE))\n            d <- object$Data$data[1:3, c(nams)]\n            d[] <- lapply(d, function (x) {x[] <- NA; x})\n            d\n        }\n    })\n    \n    ND <- reactive({\n        if (!is.null(input$RDfile) && !is.null(input$model)) {\n            if (is.null(input$patientFile)) {\n                dataObject()\n            } else {\n                d <- dataObject()\n                indF <- sapply(d, is.factor)\n                namsFactors <- names(d[indF])\n                levelsF <- lapply(d[indF], levels) \n                tt <- try(inData <- read.csv(input$patientFile$datapath, sep = input$sep, \n                                             quote=input$quote, colClasses = sapply(d, class),\n                                             dec = input$dec), TRUE)\n                if (!inherits(tt, \"try-error\")) {\n                    inData <- cbind(inData, id = rep(1, nrow(inData)))\n                    f <- function (f, l) {levels(f) <- l; f}\n                    inData[namsFactors] <- mapply(f, inData[namsFactors], \n                                                  levelsF[namsFactors], SIMPLIFY = FALSE)\n                    inData\n                }\n            }\n        }\n    })\n    \n    output$obsChoose <- renderUI({\n        if (!is.null(input$patientFile)) {\n            nr <- nrow(ND())\n            if (!is.null(nr) && nr > 1) {\n                sliderInput(\"obs\", \"Number of observations to use in prediction:\", \n                            min = 1, max = nr, value = 1, step = 1,\n                            animate = animationOptions(loop = TRUE))\n            }\n        }\n    })\n    \n    output$lastTime <- renderUI({\n        if (!is.null(input$patientFile)) {\n            object <- loadObject()\n            nd <- ND()\n            times <- nd[[object$timeVar]]\n            if (!is.null(times))\n                numericInput(\"lasttime\", \"Last time point without event:\", \n                             round(max(times, na.rm = TRUE), 2))\n        }\n    })\n    \n    output$message <- renderPrint({\n        if (is.null(input$RDfile)) {\n            cat(\"<br /><h3> <span style='color:black'> Welcome to the web interface\",\n                  \"for producing dynamic predictions from joint models using package\",\n                  \"<a href='http://cran.r-project.org/package=JMbayes'\",\n                  \"style='text-decoration:none;' target='_blank'><b>JMbayes</b></a></h3>\",\n                \"<br /><br /><h4>Use the menus on the left to load the R workspace containing the fitted joint model\",\n                \"to continue ... (for further details & instructions check the 'Help' tab above)</h4>\")\n        } else {\n            if (is.null(input$patientFile)) {\n                dataset <- ND()\n                classes <- sapply(dataset, class)\n                classes[classes == \"numeric\" | classes == \"integer\"] <- \"a numeric (continuous) variable.\"\n                ind <- classes == \"factor\"\n                classes[ind] <- paste(\"a factor (categorical) variable, with levels\", \n                    sapply(dataset[ind], function (x) paste0(\"<i>\", levels(x), \"</i>\", collapse = \", \")))\n                msg1 <- \"The data of the new subject should be stored in a CSV file with columns:\"\n                msg2 <- \"<ul style='list-style-type:circle'>\"\n                msg3 <- paste(\"<li><b>\", names(dataset), \"</b>:\", classes, \"</li>\", collapse = \" \")\n                msg4 <- \"</ul>\"\n                msg5 <- \"<br />You can use as a template the table above (e.g., copy-paste it in Excel and save it as CSV).\" \n                msg6 <- \"<u>Note:</u> R is case sensitive\"\n                cat(\"<br /><br /><p>\", paste(msg1, msg2, msg3, msg4, msg5, msg6), \"</p>\")\n            } else {\n                d <- dataObject()\n                tt <- try(inData <- read.csv(input$patientFile$datapath, sep = input$sep, \n                                             colClasses = sapply(d, class), dec = input$dec), TRUE)\n                if (inherits(tt, \"try-error\"))\n                    cat(\"<br /><span style='color:red'>Something went wrong when loading the data of the new subject;</span>\",\n                        \"<br>try tweaking the 'Separator' and 'Decimal' options on the left panel ...\")\n            }\n        } \n    })\n    \n    output$message2 <- renderPrint({\n        if (is.null(input$RDfile) || is.null(input$patientFile))\n            cat(\"<br />No subject data have been loaded yet ...\")\n    })\n    \n    output$help <- renderPrint({\n        cat(\"<br /><h3>Dynamic Predictions in a Nutshell</h3>\")\n        cat(\"<br />The dynamic predictions calculated by this app are applicable in the \", \n            \"context of follow-up studies where the aim is to utilize longitudinally \", \n            \"measured outcomes to predict future values of these outcomes or future \", \n            \"events for the sample units. For example, a cohort of patients is followed-up \",\n            \"in time and it is of interest to predict events, such as relapse of disease \",\n            \"or death using longitudinally measured biomarkers.\", \"These predictions \", \n            \"are derived under the framework of joint models for longitudinal and \", \n            \"time-to-event data, and more technical details can be found in the \", \n            \"References.\")\n        #############\n        cat(\"<br /><br /><h3>How this App Works</h3>\")\n        cat(\"<br />On the left hand side there are (or the will appear) a number of \", \n            \"control arguments.\", \"In the main panel there are three tabs, named, <span style='color:blue'>'Data'</span>,\n            <span style='color:blue'>'Event-free Probabilities'</span> and <span style='color:blue'>'Plots'</span>, in which the results appear.\")\n        p1 <- paste(\"Load the R workspace that contains the joint model(s) based on which\", \n                    \"you would like to calculated the predictions.\")\n        p21 <- paste(\"Load the comma separated file (.csv) containing the available data\", \n                     \"including both the longitudinally measured outcomes and potentially\",\n                     \"other baseline covariates, of the sample unit (e.g., patient) for\", \n                     \"which predictions are to be calculated.\")\n        p22 <- paste(\"The names of the variables/columns in this file and the coding of\", \n                     \"the categorical variables must be the same as in the database used\", \n                     \"to fit the joint model. More exact information on how this file\", \n                     \"should look like appears in the <span style='color:blue'>'Data'</span> tab after you load the R\", \n                     \"workspace in 'Step I'.\")\n        p23 <- paste(\"Depending on the locale of your machine it may be required to tweak\", \n                     \"the options <span style='color:red'>'Separator'</span>,\", \n                     \"<span style='color:red'>'Decimal'</span> and <span style='color:red'>'Quote'</span>.\")\n        p31 <- paste(\"After the R workspace has been loaded a select dialog box appears\", \n                     \"on the left hand side that allows the user to <span style='color:red'>choose the joint\", \n                     \"model</span> contained in the workspace based on which the predictions\", \n                     \"will be calculated. In addition, in the main panel, under the\", \n                     \"<span style='color:blue'>'Data'</span> tab, an example of the .csv file that the user should load\", \n                     \"appears, that gives the names of the columns that should be used\", \n                     \"and the coding for categorical variables.\")\n        p32 <- paste(\"After the user has loaded the data of the 'new' sample unit its\", \n                     \"data are depicted under the <span style='color:blue'>'Data'</span> tab.\", \n                     \"The calculation of the\", \n                     \"prediction is initiated after the user selects either the\", \n                     \"<span style='color:blue'>'Event-free Probabilities'</span> or\", \n                     \"<span style='color:blue'>'Plot'</span> tab. In addition, in the left\", \n                     \"hand side a slider appears, named\", \n                     \"<span style='color:red'>'Number of observations to use in prediction'</span>,\", \n                     \"which selects the number of measurements\", \n                     \"used in the prediction. By pressing the small play button at the\", \n                     \"end of this slider the dynamic predictions are depicted in the\", \n                     \"'Plot' tab.\")\n        p33 <- paste(\"The <span style='color:red'>'Type of Plot'</span> options on the left control the type of appearing\",\n                     \"in the 'Plot' tab. The default option <span style='color:#FE2EF7'>'Survival'</span> depicts survival\", \n                     \"probabilities (aka event-free probabilities) for the event of\", \n                     \"interest based on the avalable longitudinal measurements.\", \n                     \"Similarly, option <span style='color:#FE2EF7'>'Cumulative Incidence'</span> depicts cumulative\", \n                     \"incidence probabilities for the event of interest. Options\", \n                     \"<span style='color:#FE2EF7'>'Smiley Faces'</span> and\", \n                     \"<span style='color:#FE2EF7'>'100 Clones'</span> are used in conjuction with the\", \n                     \"<span style='color:red'>'Target Window Time'</span> option below and depict, in a simple manner, the risk that the event\",\n                     \"will occur within the time interval <i>(t, t + Dt]</i>, where <i>t</i> denotes\",\n                     \"the time of the last available longitudinal measurement (specified\", \n                     \"according to the slider 'Number of observations to use in prediction')\", \n                     \"and <i>Dt</i> is given in the 'Target Window Time'. The idea is that if at\",\n                     \"the particular time point t we would create 100 clones of the subject at hand\", \n                     \"the 'Smiley Faces' and '100 Clones' plots show how many of them would die within the\", \n                     \"time interval from <i>t</i> up to <i>t + Dt</i>.\",\n                     \"Finally, option <span style='color:#FE2EF7'>'Longitudinal'</span>\", \n                     \"can be selected to depict predictions for the longitudinal outcome based\", \n                     \"on the recored information.\")\n        p34 <- paste(\"The field <span style='color:red'>'Target horizon time'</span> specifies a horizon time point at\", \n                     \"which predictions are of interest. For example, 10-year survival probability.\")\n        p35 <- paste(\"The field <span style='color:red'>'Monte Carlo samples'</span> specifies the number of Monte Carlo\", \n                     \"samples used in calculating the predictions-more details can be found\", \n                     \"in the References.\")\n        cat(\"<dl><dt>Step I</dt>\", \"<dd>- \", p1, \"</dd>\", \"<dd>  </dd>\",\n            \"<dt>Step II</dt>\", \"<dd>- \", p21, \"</dd>\", \"<dd>- \", p22, \"</dd>\", \"<dd>- \", p23, \"</dd>\", \"<dd>  </dd>\",\n            \"<dt>Options & Widgets</dt>\", \"<dd>- \", p31, \"</dd>\", \"<dd>- \", p32, \"</dd>\", \n            \"<dd>- \", p33, \"</dd>\", \"<dd>- \", p34, \"</dd>\", \"<dd>- \", p35, \"</dd>\", \"</dl>\")\n        #############\n        cat(\"<br /><h3>References</h3>\")\n        p1 <- paste0(\"<li>\", \"Yu M, Taylor J, Sandler H. (2008). \",\n                     \"Individualized prediction in prostate cancer studies using a joint longitudinal-survival-cure model. \",\n                     \"<a href='http://dx.doi.org/10.1198/016214507000000400' \", \n                     \"style='text-decoration:none;' target='_blank'>\", \n                     \"<i>Journal of the American Statistical Association</i> <b> 103</b>, 178-187.</a>\",\n                     \"</li>\")\n        p2 <- paste0(\"<li>\", \"Rizopoulos D. (2011). Dynamic predictions and prospective \",\n                     \"accuracy in joint models for longitudinal and time-to-event data. \",\n                     \"<a href='http://dx.doi.org/10.1111/j.1541-0420.2010.01546.x' \", \n                     \"style='text-decoration:none;' target='_blank'>\", \n                     \"<i>Biometrics</i> <b> 67</b>, 819-829.</a>\",\n                     \"</li>\")\n        p3 <- paste0(\"<li>\", \"Rizopoulos D. (2012). \",\n                     \"<a href='http://www.crcpress.com/product/isbn/9781439872864' \", \n                     \"style='text-decoration:none;' target='_blank'>\", \n                     \"<i>Joint Models for Longitudinal and Time-to-Event Data, with Applications in R</i></a>.\",\n                     \" Boca Raton: Chapman & Hall/CRC.\",\n                     \"</li>\")\n        p4 <- paste0(\"<li>\", \"Taylor J, Park Y, Ankerst D, Proust-Lima C, \", \n                     \"Williams S, Kestin L, Bae K, Pickles T, Sandler H. (2013). \",\n                     \"Real-time individual predictions of prostate cancer recurrence\", \n                     \"using joint models. \", \"<a href='http://dx.doi.org/10.1111/j.1541-0420.2012.01823.x' \", \n                     \"style='text-decoration:none;' target='_blank'>\", \n                     \"<i>Biometrics</i> <b> 69</b>, 206-213.</a>\",\n                     \"</li>\")\n        cat(\"<ol>\", p1, p2, p3, p4, \"</ol> \")\n    })\n    \n    sfits <- reactive({\n        if (!is.null(input$patientFile) && input$TypePlot != 'longitudinal') {\n            object <- loadObject()\n            nd <- ND()\n            n <- nrow(nd)\n            lastTimeUser <- input$lasttime\n            lastTimeData <- max(nd[[object$timeVar]])\n            sfits <- vector(\"list\", n)\n            for (i in 1:n) {\n                lt <- if (i == n && !is.na(lastTimeUser) && lastTimeUser > lastTimeData) \n                    lastTimeUser else NULL\n                sfits[[i]] <- survfitJM(object, newdata = nd[1:i, ], M = input$M, \n                                        last.time = lt)\n            }\n            sfits\n        }\n    })\n    \n    lfits <- reactive({\n        if (!is.null(input$patientFile) && input$TypePlot == 'longitudinal') {\n            object <- loadObject()\n            nd <- ND()\n            n <- nrow(nd)\n            lastTimeUser <- input$lasttime\n            lastTimeData <- max(nd[[object$timeVar]])\n            lfits <- vector(\"list\", n)\n            for (i in 1:n) {\n                lt <- if (i == n && !is.na(lastTimeUser) && lastTimeUser > lastTimeData) \n                    lastTimeUser else NULL\n                lfits[[i]] <- predict(object, newdata = nd[1:i, ], M = input$M, \n                                      returnData = TRUE, type = \"Subject\", \n                                      interval = \"prediction\", last.time = lt)\n            }\n            lfits\n        }\n    })\n    \n    sfits2 <- reactive({\n        if (!is.na(input$time) || !is.na(input$windowTime)) {\n            object <- loadObject()\n            nd <- ND()\n            n <- nrow(nd)\n            lastTimeUser <- input$lasttime\n            sfits <- vector(\"list\", n)\n            for (i in 1:n) {\n                lastTimeData <- max(nd[1:i, object$timeVar])\n                target.time <- if (!is.na(input$windowTime)) lastTimeData + input$windowTime else input$time\n                lt <- if (i == n && !is.na(lastTimeUser) && lastTimeUser > lastTimeData) \n                    lastTimeUser else NULL\n                if (i == n && !is.na(lastTimeUser) && lastTimeUser > lastTimeData && !is.na(input$windowTime))\n                    target.time <- lastTimeUser + input$windowTime\n                if (target.time > lastTimeData)\n                    sfits[[i]] <- survfitJM(object, newdata = nd[1:i, ], \n                                            survTimes = target.time, M = input$M,\n                                            last.time = lt)\n            }\n            sfits\n        }\n    })\n    \n    output$contents <- renderTable({\n        if (!is.null(input$RDfile)) {\n            nd <- ND()\n            if (!is.null(input$patientFile)) {\n                tt <- try(nd[, head(1:ncol(nd), -1)], TRUE)\n                if (!inherits(tt, \"try-error\"))\n                    nd <- tt\n            }\n            nd\n        }\n    })\n    \n    sprobs <- reactive({\n        if (!is.null(input$patientFile)) {\n            if (is.na(input$time) && is.na(input$windowTime)) {\n                sfits. <- sfits()\n            } else {\n                sfits. <- sfits2()\n            }\n            nn <- if(is.na(input$obs)) length(sfits.) else input$obs\n            ss <- sfits.[[nn]]\n            if (!is.null(ss)) {\n                sf <- sfits.[[nn]]\n                f <- function (d, t) {\n                    dd <- d[1, , drop = FALSE]\n                    dd[1, ] <- c(as.vector(t), rep(1, ncol(dd) - 1))\n                    round(rbind(dd, d), 4)\n                }\n                d <- mapply(f, sf$summaries, sf$last.time, SIMPLIFY = FALSE)\n                d <- d[[1L]][, c(1,2,4,5), drop = FALSE]\n                colnames(d) <- c(\"time\", \"Surv\", \"95% low\", \"95% upp\")\n                nr <- nrow(d)\n                out <- if (nr > 10) d[round(seq(1, nr, length.out = 10)), ] else d\n                rownames(out) <- NULL\n                out\n            } else NULL\n        }\n    })\n    \n    output$survprobs <- renderTable({\n        sprobs()\n    })\n    \n    output$plot <- renderPlot({\n        if (!is.null(input$patientFile)) {\n            if (input$TypePlot != 'longitudinal') {\n                if (!is.na(input$windowTime) && (input$TypePlot == \"stickMan\" \n                                                          || input$TypePlot == \"smFace\")) {\n                    stickMan <- input$TypePlot == \"stickMan\"\n                    sfits. <- sfits2()\n                    nn <- if(is.na(input$obs)) length(sfits.) else input$obs\n                    ss <- round(100 * (1 - sfits.[[nn]][[\"summaries\"]][[1]][1, 2]))\n                    draw.stick <- JMbayes:::draw.stick\n                    smilyface <- JMbayes:::smilyface\n                    if (stickMan) {\n                        xx <- seq(0.2, 1.1, 0.1)\n                        yy <- seq(0.0, 1.8, 0.2)\n                    } else {\n                        xx <- seq(0.3, 0.8, len = 10)\n                        yy <- seq(0.45, 1.8, len = 10)\n                    }\n                    cords <- data.matrix(expand.grid(xx, rev(yy)))\n                    cols <- rep(\"blue\", 100) \n                    cols[seq_len(ss)] <- \"red\"\n                    op <- par(mar = c(0, 0, 2.1, 0))\n                    plot(c(.25, 1.25), c(0, 2), type = \"n\", xaxt = 'n', yaxt = 'n', ann = FALSE)\n                    title(paste0(\"Risk = \", ss, \"%\"), cex.main = 1.7)\n                    for (cc in 1:100) {\n                        if (stickMan) {\n                            draw.stick(cords[cc, 1], cords[cc, 2], linecol = cols[cc], scale = 0.2)\n                        } else {\n                            m <- if (cols[cc] == \"blue\") \"happy\" else \"sad\"\n                            smilyface(cords[cc, ], 0.01, mood = m)\n                        }\n                    }\n                    par(op)\n                } else {\n                    sfits. <- sfits()\n                    nn <- if(is.na(input$obs)) length(sfits.) else input$obs\n                    if (input$TypePlot == \"surv\") {\n                        plot(sfits.[[nn]], estimator = \"mean\", conf.int = TRUE, fill.area = TRUE, \n                             include.y = TRUE, lwd = 2, ask = FALSE, cex = 2, main = \"\")                \n                    }\n                    if (input$TypePlot == \"cumInc\") {\n                        plot(sfits.[[nn]], estimator = \"mean\", conf.int = TRUE, fill.area = TRUE, \n                             include.y = TRUE, lwd = 2, ask = FALSE, cex = 2, main = \"\",\n                             fun = function (s) 1 - s, ylab = \"Cumulative Incidence\")                \n                    }\n                    if (!is.na(input$windowTime) || !is.na(input$time)) {\n                        object <- loadObject()\n                        nd <- ND()\n                        nr <- nrow(nd)\n                        lastTimeUser <- input$lasttime\n                        lastTimeData <- max(nd[1:nn, object$timeVar])\n                        target.time <- if (nn == nr && !is.na(lastTimeUser) && \n                                               lastTimeUser > lastTimeData) {\n                            if (!is.na(input$windowTime)) lastTimeUser + input$windowTime else input$time\n                        } else {\n                            if (!is.na(input$windowTime)) lastTimeData + input$windowTime else input$time\n                        }\n                        abline(v = target.time, lty = 2, col = 2, lwd = 2)\n                    }\n                }\n            } else {\n                object <- loadObject()\n                lfits. <- lfits()\n                require(\"lattice\")\n                nn <- if(is.na(input$obs)) length(lfits.) else input$obs\n                timeVar <- object$timeVar\n                resp <- paste(object$Forms$formYx)[2L]\n                tv <- lfits.[[nn]][[timeVar]]\n                lastTimeData <- with(lfits.[[nn]], tv[!is.na(low)][1])\n                lastTimeUser <- input$lasttime\n                lastTime <- if (nn == length(lfits.)) \n                    max(lastTimeData, lastTimeUser, na.rm = TRUE) else lastTimeData\n                form <- as.formula(paste(\"pred + low + upp +\", resp, \"~\", timeVar))\n                yl <- range(c(data.matrix(do.call(rbind, lfits.)[c(\"pred\", \"low\", \"upp\")])),\n                            na.rm = TRUE)\n                yl <- yl + c(-0.05, 0.05) * yl\n                target.time <- if (!is.na(input$windowTime) || !is.na(input$time)) {\n                    object <- loadObject()\n                    nd <- ND()\n                    nr <- nrow(nd)\n                    lastTimeUser <- input$lasttime\n                    lastTimeData <- max(nd[1:nn, object$timeVar])\n                    if (nn == nr && !is.na(lastTimeUser) && \n                                           lastTimeUser > lastTimeData) {\n                        if (!is.na(input$windowTime)) lastTimeUser + input$windowTime else input$time\n                    } else {\n                        if (!is.na(input$windowTime)) lastTimeData + input$windowTime else input$time\n                    }\n                } else NA\n                print(xyplot(form, data = lfits.[[nn]], last.time = lastTime, target.time = target.time,\n                             panel = function (..., last.time, target.time) {\n                                 xx <- ..1; yy <- ..2; ind <- ..4\n                                 xx <- do.call(cbind, split(xx, ind))\n                                 yy <- do.call(cbind, split(yy, ind))\n                                 na.ind <- is.na(yy[, 2])\n                                 lx <- xx[!na.ind, 2]; ll <- yy[!na.ind, 2]; lu <- yy[!na.ind, 3]\n                                 lpolygon(c(lx, rev(lx)), c(ll, rev(lu)), border = \"transparent\", \n                                          col = \"lightgrey\")\n                                 panel.xyplot(xx[, 1], yy[, 1], type = \"l\", lty = 1, col = 2, lwd = 2)\n                                 panel.xyplot(xx[, 2], yy[, 2], type = \"l\", lty = 2, col = 1, lwd = 2)\n                                 panel.xyplot(xx[, 3], yy[, 3], type = \"l\", lty = 2, col = 1, lwd = 2)\n                                 panel.xyplot(xx[na.ind, 4], yy[na.ind, 4], type = \"p\", pch = 8, \n                                              cex = 1.1, col = 1)\n                                 panel.abline(v = last.time, lty = 3)\n                                 if (!is.na(target.time))\n                                     panel.abline(v = target.time, lty = 2, col = 2, lwd = 2)\n                             }, xlab = \"Time\", ylim = yl,\n                             ylab = paste(\"Predicted\", resp)))\n            }\n        }\n    })\n        \n    output$downloadData <- downloadHandler(\n        filename = function () { paste(input$dataset, '.csv', sep = '') },\n        content = function (file) {\n            write.table(sprobs(), file, sep = input$sep, dec = input$dec,\n                        row.names = FALSE)\n        }\n    )\n    \n    output$downloadPlot <- downloadHandler(\n        filename = function () { paste(input$dataset, '.png', sep = '') },\n        content = function (file) {\n            png(file)\n            #sfits. <- sfits()\n            #nn <- if(is.na(input$obs)) length(sfits.) else input$obs\n            #plot(sfits.[[nn]], estimator = \"mean\", conf.int = TRUE, fill.area = TRUE, \n            #     include.y = TRUE, lwd = 2, ask = FALSE, cex = 2, main = \"\")\n            if (!is.null(input$patientFile)) {\n                if (input$TypePlot != 'longitudinal') {\n                    if (!is.na(input$windowTime) && (input$TypePlot == \"stickMan\" \n                                                     || input$TypePlot == \"smFace\")) {\n                        stickMan <- input$TypePlot == \"stickMan\"\n                        sfits. <- sfits2()\n                        nn <- if(is.na(input$obs)) length(sfits.) else input$obs\n                        ss <- round(100 * (1 - sfits.[[nn]][[\"summaries\"]][[1]][1, 2]))\n                        draw.stick <- JMbayes:::draw.stick\n                        smilyface <- JMbayes:::smilyface\n                        if (stickMan) {\n                            xx <- seq(0.2, 1.1, 0.1)\n                            yy <- seq(0.0, 1.8, 0.2)\n                        } else {\n                            xx <- seq(0.3, 0.8, len = 10)\n                            yy <- seq(0.45, 1.8, len = 10)\n                        }\n                        cords <- data.matrix(expand.grid(xx, rev(yy)))\n                        cols <- rep(\"blue\", 100) \n                        cols[seq_len(ss)] <- \"red\"\n                        op <- par(mar = c(0, 0, 2.1, 0))\n                        plot(c(.25, 1.25), c(0, 2), type = \"n\", xaxt = 'n', yaxt = 'n', ann = FALSE)\n                        title(paste0(\"Risk = \", ss, \"%\"), cex.main = 1.7)\n                        for (cc in 1:100) {\n                            if (stickMan) {\n                                draw.stick(cords[cc, 1], cords[cc, 2], linecol = cols[cc], scale = 0.2)\n                            } else {\n                                m <- if (cols[cc] == \"blue\") \"happy\" else \"sad\"\n                                smilyface(cords[cc, ], 0.01, mood = m)\n                            }\n                        }\n                        par(op)\n                    } else {\n                        sfits. <- sfits()\n                        nn <- if(is.na(input$obs)) length(sfits.) else input$obs\n                        if (input$TypePlot == \"surv\") {\n                            plot(sfits.[[nn]], estimator = \"mean\", conf.int = TRUE, fill.area = TRUE, \n                                 include.y = TRUE, lwd = 2, ask = FALSE, cex = 2, main = \"\")                \n                        }\n                        if (input$TypePlot == \"cumInc\") {\n                            plot(sfits.[[nn]], estimator = \"mean\", conf.int = TRUE, fill.area = TRUE, \n                                 include.y = TRUE, lwd = 2, ask = FALSE, cex = 2, main = \"\",\n                                 fun = function (s) 1 - s, ylab = \"Cumulative Incidence\")                \n                        }\n                        if (!is.na(input$windowTime) || !is.na(input$time)) {\n                            object <- loadObject()\n                            nd <- ND()\n                            nr <- nrow(nd)\n                            lastTimeUser <- input$lasttime\n                            lastTimeData <- max(nd[1:nn, object$timeVar])\n                            target.time <- if (nn == nr && !is.na(lastTimeUser) && \n                                                   lastTimeUser > lastTimeData) {\n                                if (!is.na(input$windowTime)) lastTimeUser + input$windowTime else input$time\n                            } else {\n                                if (!is.na(input$windowTime)) lastTimeData + input$windowTime else input$time\n                            }\n                            abline(v = target.time, lty = 2, col = 2, lwd = 2)\n                        }\n                    }\n                } else {\n                    object <- loadObject()\n                    lfits. <- lfits()\n                    require(\"lattice\")\n                    nn <- if(is.na(input$obs)) length(lfits.) else input$obs\n                    timeVar <- object$timeVar\n                    resp <- paste(object$Forms$formYx)[2L]\n                    tv <- lfits.[[nn]][[timeVar]]\n                    lastTimeData <- with(lfits.[[nn]], tv[!is.na(low)][1])\n                    lastTimeUser <- input$lasttime\n                    lastTime <- if (nn == length(lfits.)) \n                        max(lastTimeData, lastTimeUser, na.rm = TRUE) else lastTimeData\n                    form <- as.formula(paste(\"pred + low + upp +\", resp, \"~\", timeVar))\n                    yl <- range(c(data.matrix(do.call(rbind, lfits.)[c(\"pred\", \"low\", \"upp\")])),\n                                na.rm = TRUE)\n                    yl <- yl + c(-0.05, 0.05) * yl\n                    target.time <- if (!is.na(input$windowTime) || !is.na(input$time)) {\n                        object <- loadObject()\n                        nd <- ND()\n                        nr <- nrow(nd)\n                        lastTimeUser <- input$lasttime\n                        lastTimeData <- max(nd[1:nn, object$timeVar])\n                        if (nn == nr && !is.na(lastTimeUser) && \n                                lastTimeUser > lastTimeData) {\n                            if (!is.na(input$windowTime)) lastTimeUser + input$windowTime else input$time\n                        } else {\n                            if (!is.na(input$windowTime)) lastTimeData + input$windowTime else input$time\n                        }\n                    } else NA\n                    print(xyplot(form, data = lfits.[[nn]], last.time = lastTime, target.time = target.time,\n                                 panel = function (..., last.time, target.time) {\n                                     xx <- ..1; yy <- ..2; ind <- ..4\n                                     xx <- do.call(cbind, split(xx, ind))\n                                     yy <- do.call(cbind, split(yy, ind))\n                                     na.ind <- is.na(yy[, 2])\n                                     lx <- xx[!na.ind, 2]; ll <- yy[!na.ind, 2]; lu <- yy[!na.ind, 3]\n                                     lpolygon(c(lx, rev(lx)), c(ll, rev(lu)), border = \"transparent\", \n                                              col = \"lightgrey\")\n                                     panel.xyplot(xx[, 1], yy[, 1], type = \"l\", lty = 1, col = 2, lwd = 2)\n                                     panel.xyplot(xx[, 2], yy[, 2], type = \"l\", lty = 2, col = 1, lwd = 2)\n                                     panel.xyplot(xx[, 3], yy[, 3], type = \"l\", lty = 2, col = 1, lwd = 2)\n                                     panel.xyplot(xx[na.ind, 4], yy[na.ind, 4], type = \"p\", pch = 8, \n                                                  cex = 1.1, col = 1)\n                                     panel.abline(v = last.time, lty = 3)\n                                     if (!is.na(target.time))\n                                         panel.abline(v = target.time, lty = 2, col = 2, lwd = 2)\n                                 }, xlab = \"Time\", ylim = yl,\n                                 ylab = paste(\"Predicted\", resp)))\n                }\n            }\n            dev.off()\n        }\n    )\n})",
    "created" : 1444643372256.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3784548435",
    "id" : "626C8F59",
    "lastKnownWriteTime" : 1444653677,
    "path" : "C:/Users/Dimitris/Documents/PackagesGitHub/JMbayes/demo/server.R",
    "project_path" : "demo/server.R",
    "properties" : {
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "type" : "r_source"
}